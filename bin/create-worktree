#!/bin/bash

# Git Worktree ä½œæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯å¯¾è©±çš„ã«Git worktreeã‚’ä½œæˆã—ã€é–‹ç™ºç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™

set -euo pipefail

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±
VERSION="2.0.0"

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
DEFAULT_NUM_WORKTREES=2
DEFAULT_SETUP_ENV=true
DEFAULT_COPY_FILES=true

# ã‚«ãƒ©ãƒ¼å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦çµ‚äº†
error_exit() {
    echo -e "${RED}ã‚¨ãƒ©ãƒ¼: $1${NC}" >&2
    exit 1
}

# æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
success_msg() {
    echo -e "${GREEN}âœ“ $1${NC}" >&2
}

# è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
warning_msg() {
    echo -e "${YELLOW}âš ï¸  $1${NC}" >&2
}

# æƒ…å ±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
info_msg() {
    echo -e "${BLUE}$1${NC}"
}

# ä½¿ç”¨æ–¹æ³•ã‚’è¡¨ç¤º
show_usage() {
    echo "Git Worktree ä½œæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ v$VERSION"
    echo
    echo "ä½¿ç”¨æ–¹æ³•:"
    echo "  $0 [ã‚ªãƒ—ã‚·ãƒ§ãƒ³]"
    echo
    echo "ã‚ªãƒ—ã‚·ãƒ§ãƒ³:"
    echo "  -b, --base-branch BRANCH    ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã‚’æŒ‡å®š"
    echo "  -n, --num-worktrees NUM     ä½œæˆã™ã‚‹worktreeã®æ•° (1-10)"
    echo "  -p, --base-path PATH        worktreeã®ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹"
    echo "  --no-setup                  é–‹ç™ºç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—"
    echo "  --no-copy                   ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ”ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—"
    echo "  -q, --quiet                 è©³ç´°å‡ºåŠ›ã‚’æŠ‘åˆ¶"
    echo "  -h, --help                  ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"
    echo "  --version                   ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’è¡¨ç¤º"
    echo
    echo "ä¾‹:"
    echo "  $0                                    # å¯¾è©±ãƒ¢ãƒ¼ãƒ‰"
    echo "  $0 -b main -n 3 -p ../feature-auth   # éå¯¾è©±ãƒ¢ãƒ¼ãƒ‰"
    echo "  $0 --base-branch develop --num-worktrees 2 --base-path ../hotfix"
}

# ãƒ–ãƒ©ãƒ³ãƒã®å­˜åœ¨ã‚’ç¢ºèª
branch_exists() {
    local branch=$1
    git show-ref --verify --quiet "refs/heads/$branch" || 
    git show-ref --verify --quiet "refs/remotes/origin/$branch"
}

# ãƒ–ãƒ©ãƒ³ãƒä¸€è¦§ã‚’è¡¨ç¤º
show_branches() {
    echo "ç¾åœ¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ãƒ³ãƒä¸€è¦§:"
    local local_branches=$(git branch --format="%(refname:short)" 2>/dev/null)
    if [ -z "$local_branches" ]; then
        echo "  (ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ãƒ³ãƒãŒã‚ã‚Šã¾ã›ã‚“)"
    else
        echo "$local_branches" | sed 's/^/  - /'
    fi
    echo
    
    echo "ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒä¸€è¦§:"
    local remote_branches=$(git branch -r --format="%(refname:short)" 2>/dev/null | grep -v "HEAD" 2>/dev/null)
    if [ -z "$remote_branches" ]; then
        echo "  (ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒãŒã‚ã‚Šã¾ã›ã‚“)"
    else
        echo "$remote_branches" | sed 's/^/  - /'
    fi
    echo
}

# worktreeä¸€è¦§ã‚’è¡¨ç¤º
show_worktrees() {
    echo "æ—¢å­˜ã®worktreeä¸€è¦§:"
    git worktree list
    echo
}

# ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã‚’é¸æŠ
select_base_branch() {
    local current_branch=$(git branch --show-current)
    local base_branch
    
    # ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒãŒç©ºã®å ´åˆï¼ˆåˆæœŸçŠ¶æ…‹ï¼‰ã®å‡¦ç†
    if [ -z "$current_branch" ]; then
        current_branch="HEAD"
    fi
    
    while true; do
        read -p "æ–°ã—ã„worktreeã®ãƒ™ãƒ¼ã‚¹ã«ã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: $current_branch): " base_branch
        
        # å…¥åŠ›ãŒãªã„å ´åˆã¯ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã‚’ä½¿ç”¨
        if [ -z "$base_branch" ]; then
            base_branch="$current_branch"
            success_msg "ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ '$base_branch' ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¾ã™ã€‚"
            echo "$base_branch"
            return 0
        fi
        
        # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ãƒ³ãƒã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if git show-ref --verify --quiet "refs/heads/$base_branch"; then
            success_msg "ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ãƒ³ãƒ '$base_branch' ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¾ã™ã€‚"
            echo "$base_branch"
            return 0
        # ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        elif git show-ref --verify --quiet "refs/remotes/origin/$base_branch"; then
            success_msg "ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒ 'origin/$base_branch' ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¾ã™ã€‚"
            echo "origin/$base_branch"
            return 0
        else
            warning_msg "ãƒ–ãƒ©ãƒ³ãƒ '$base_branch' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
            read -p "ãã‚Œã§ã‚‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N): " confirm
            if [[ $confirm =~ ^[Yy]$ ]]; then
                echo "$base_branch"
                return 0
            fi
        fi
    done
}

# ä½œæˆã™ã‚‹worktreeã®æ•°ã‚’å…¥åŠ›
get_num_worktrees() {
    local num_worktrees
    while true; do
        read -p "ä½œæˆã™ã‚‹worktreeã®æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (1-10, ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 2): " num_worktrees
        num_worktrees=${num_worktrees:-2}
        if ! [[ "$num_worktrees" =~ ^[1-9]$|^10$ ]]; then
            warning_msg "1ã‹ã‚‰10ã®é–“ã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"
            continue
        fi
        echo "$num_worktrees"
        return 0
    done
}

# worktreeã®ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ã‚’å…¥åŠ›
get_worktree_base_path() {
    local worktree_base_path
    local num_worktrees=$1

    while true; do
        read -p "æ–°ã—ã„worktreeã®ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ä¾‹: ../feature-login): " worktree_base_path
        
        if [ -z "$worktree_base_path" ]; then
            echo "ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"
            continue
        fi

        local conflict=false
        for i in $(seq 1 "$num_worktrees"); do
            local worktree_dir="${worktree_base_path}-${i}"
            local branch_name
            branch_name=$(basename "$worktree_dir")

            if git show-ref --verify --quiet "refs/heads/$branch_name"; then
                warning_msg "ãƒ–ãƒ©ãƒ³ãƒ '$branch_name' ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚"
                conflict=true
            fi

            if [ -d "$worktree_dir" ]; then
                warning_msg "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª '$worktree_dir' ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚"
                conflict=true
            fi
        done

        if [ "$conflict" = true ]; then
            read -p "ç«¶åˆãŒã‚ã‚Šã¾ã™ãŒã€ãã‚Œã§ã‚‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N): " confirm
            if [[ ! $confirm =~ ^[Yy]$ ]]; then
                continue
            fi
        fi
        
        echo "$worktree_base_path"
        return 0
    done
}

# ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‚’è§£æ
parse_arguments() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            -b|--base-branch)
                BASE_BRANCH="$2"
                shift 2
                ;;
            -n|--num-worktrees)
                NUM_WORKTREES="$2"
                if ! [[ "$NUM_WORKTREES" =~ ^[1-9]$|^10$ ]]; then
                    error_exit "worktreeã®æ•°ã¯1ã‹ã‚‰10ã®é–“ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚"
                fi
                shift 2
                ;;
            -p|--base-path)
                WORKTREE_BASE_PATH="$2"
                shift 2
                ;;
            --no-setup)
                SETUP_ENV=false
                shift
                ;;
            --no-copy)
                COPY_FILES=false
                shift
                ;;
            -q|--quiet)
                QUIET=true
                shift
                ;;
            -h|--help)
                show_usage
                exit 0
                ;;
            --version)
                echo "Git Worktree ä½œæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ v$VERSION"
                exit 0
                ;;
            *)
                error_exit "ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1\nä½¿ç”¨æ–¹æ³•: $0 --help"
                ;;
        esac
    done
}

# ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ”ãƒ¼å‡¦ç†
copy_files_to_worktree() {
    local worktree_path=$1
    
    if [ "$COPY_FILES" = false ]; then
        return 0
    fi
    
    # .gitignoreã‚’ã‚³ãƒ”ãƒ¼
    if [ -f ".gitignore" ]; then
        cp ".gitignore" "$worktree_path/"
        [ "$QUIET" != true ] && success_msg ".gitignoreã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚"
    fi

    # .tree-copy-listã«åŸºã¥ããƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ”ãƒ¼
    if [ -f ".tree-copy-list" ]; then
        [ "$QUIET" != true ] && info_msg "ğŸ“„ .tree-copy-listã«åŸºã¥ã„ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ä¸­..."
        local copied_count=0
        while IFS= read -r file || [[ -n "$file" ]]; do
            if [[ -z "$file" || "$file" =~ ^[[:space:]]*$ || "$file" =~ ^# ]]; then
                continue
            fi
            file=$(echo "$file" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            if [ -e "$file" ]; then
                local target_dir="$worktree_path/$(dirname "$file")"
                mkdir -p "$target_dir"
                if cp -r "$file" "$target_dir/"; then
                    [ "$QUIET" != true ] && success_msg "ã‚³ãƒ”ãƒ¼: $file"
                    ((copied_count++))
                else
                    warning_msg "ã‚³ãƒ”ãƒ¼å¤±æ•—: $file"
                fi
            else
                warning_msg "ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $file"
            fi
        done < ".tree-copy-list"
        [ "$QUIET" != true ] && success_msg "$copied_count ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚"
    fi
}

# é–‹ç™ºç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
setup_development_environment() {
    local worktree_path=$1
    
    if [ "$SETUP_ENV" = false ]; then
        return 0
    fi

    # VS Codeã§é–‹ã
    if command -v code &> /dev/null; then
        [ "$QUIET" != true ] && info_msg "ğŸ“ VS Codeã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é–‹ã„ã¦ã„ã¾ã™..."
        code "$worktree_path" &
    else
        [ "$QUIET" != true ] && warning_msg "VS Codeã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
    fi
    
    # Warpã®æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é–‹ã
    [ "$QUIET" != true ] && info_msg "ğŸš€ Warpã®æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é–‹ã„ã¦ã„ã¾ã™..."
    local absolute_worktree_path
    absolute_worktree_path=$(cd "$worktree_path" && pwd)
    if command -v warp &> /dev/null; then
        [ "$QUIET" != true ] && info_msg "Warp CLIã‚’ä½¿ç”¨ã—ã¾ã™"
        warp launch --new-window --path "$absolute_worktree_path" &
    else
        [ "$QUIET" != true ] && info_msg "Warp CLIãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€'open'ã‚³ãƒãƒ³ãƒ‰ã§ä»£æ›¿ã—ã¾ã™"
        # 'open'ã‚³ãƒãƒ³ãƒ‰ã¯ã‚ˆã‚Šå …ç‰¢ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        open -a Warp "$absolute_worktree_path" &
    fi

    # yabaiãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’æ•´ç†
    if command -v yabai &> /dev/null; then
        [ "$QUIET" != true ] && info_msg "yabaiã‚’æ¤œå‡ºã—ã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’æ•´ç†å¾Œã«ã‚¿ã‚¤ãƒ«ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤ã—ã¾ã™..."
        # ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‹ãã®ã‚’å°‘ã—å¾…ã¤
        sleep 1
        # ç¾åœ¨ã®ã‚¹ãƒšãƒ¼ã‚¹ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’bsp(tiling)ã«å¤‰æ›´ã—ã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’æ•´ç†
        # ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¤‰æ›´ãŒå¤±æ•—ã™ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚‹ï¼ˆä¾‹: SIPè¨­å®šï¼‰
        if yabai -m space --layout bsp; then
            yabai -m space --balance
            # å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™
            sleep 0.5
            yabai -m space --layout float
            [ "$QUIET" != true ] && success_msg "yabai: ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’æ•´åˆ—ã—ã€ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã—ã¾ã—ãŸã€‚"
        else
            warning_msg "yabai: ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç¾åœ¨ã®ã‚¹ãƒšãƒ¼ã‚¹ã¯yabaiã§ç®¡ç†ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"
        fi
    fi
}

# worktreeã‚’ä½œæˆ
create_worktree() {
    local base_branch=$1
    local num_worktrees=$2
    local worktree_base_path=$3
    
    # worktreeä½œæˆãƒ«ãƒ¼ãƒ—
    for i in $(seq 1 "$num_worktrees"); do
        local worktree_dir="${worktree_base_path}-${i}"
        local new_branch
        new_branch=$(basename "$worktree_dir")

        [ "$QUIET" != true ] && echo
        [ "$QUIET" != true ] && info_msg "--- [${i}/${num_worktrees}] worktreeä½œæˆä¸­: $worktree_dir ---"

        # å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’æ§‹ç¯‰
        local cmd="git worktree add -b $new_branch $worktree_dir $base_branch"
        
        [ "$QUIET" != true ] && echo "å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰:"
        [ "$QUIET" != true ] && echo "  $cmd"
        [ "$QUIET" != true ] && echo
        
        # worktreeä½œæˆå®Ÿè¡Œ
        if eval "$cmd" 2>/dev/null; then
            [ "$QUIET" != true ] && success_msg "worktreeãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼"
            
            # ä½œæˆã—ãŸworktreeãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®çµ¶å¯¾ãƒ‘ã‚¹ã‚’å–å¾—
            local worktree_path
            worktree_path=$(realpath "$worktree_dir")
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ”ãƒ¼å‡¦ç†
            copy_files_to_worktree "$worktree_path"
            
            # é–‹ç™ºç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
            setup_development_environment "$worktree_path"
        else
            error_exit "worktree '$worktree_dir' ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
        fi
    done
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    # ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®åˆæœŸåŒ–
    BASE_BRANCH=""
    NUM_WORKTREES=""
    WORKTREE_BASE_PATH=""
    SETUP_ENV=$DEFAULT_SETUP_ENV
    COPY_FILES=$DEFAULT_COPY_FILES
    QUIET=false
    
    # ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‚’è§£æ
    parse_arguments "$@"
    
    [ "$QUIET" != true ] && echo "=== Git Worktree ä½œæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ v$VERSION ==="
    [ "$QUIET" != true ] && echo
    
    # ç¾åœ¨ã®Gitãƒªãƒã‚¸ãƒˆãƒªã‹ãƒã‚§ãƒƒã‚¯
    if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
        error_exit "ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯Gitãƒªãƒã‚¸ãƒˆãƒªã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
    fi
    
    # ã‚³ãƒŸãƒƒãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if ! git rev-parse HEAD >/dev/null 2>&1; then
        error_exit "ãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã«ä½•ã‹ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚"
    fi
    
    # éå¯¾è©±ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯å¼•æ•°ãƒã‚§ãƒƒã‚¯
    if [ -n "$BASE_BRANCH" ] && [ -n "$NUM_WORKTREES" ] && [ -n "$WORKTREE_BASE_PATH" ]; then
        # éå¯¾è©±ãƒ¢ãƒ¼ãƒ‰
        [ "$QUIET" != true ] && info_msg "éå¯¾è©±ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œã—ã¾ã™ã€‚"
        
        # ç«¶åˆãƒã‚§ãƒƒã‚¯
        local conflict=false
        for i in $(seq 1 "$NUM_WORKTREES"); do
            local worktree_dir="${WORKTREE_BASE_PATH}-${i}"
            local branch_name
            branch_name=$(basename "$worktree_dir")

            if git show-ref --verify --quiet "refs/heads/$branch_name" 2>/dev/null; then
                warning_msg "ãƒ–ãƒ©ãƒ³ãƒ '$branch_name' ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚"
                conflict=true
            fi

            if [ -d "$worktree_dir" ]; then
                warning_msg "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª '$worktree_dir' ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚"
                conflict=true
            fi
        done

        if [ "$conflict" = true ]; then
            error_exit "ç«¶åˆãŒã‚ã‚Šã¾ã™ã€‚æ—¢å­˜ã®ãƒ–ãƒ©ãƒ³ãƒã‚„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
        fi
        
        create_worktree "$BASE_BRANCH" "$NUM_WORKTREES" "$WORKTREE_BASE_PATH"
    else
        # å¯¾è©±ãƒ¢ãƒ¼ãƒ‰
        [ "$QUIET" != true ] && info_msg "å¯¾è©±ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œã—ã¾ã™ã€‚"
        
        # ãƒ–ãƒ©ãƒ³ãƒã¨worktreeæƒ…å ±ã‚’è¡¨ç¤º
        [ "$QUIET" != true ] && show_branches
        [ "$QUIET" != true ] && show_worktrees
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’å–å¾—
        local base_branch=${BASE_BRANCH:-$(select_base_branch)}
        local num_worktrees=${NUM_WORKTREES:-$(get_num_worktrees)}
        local worktree_base_path=${WORKTREE_BASE_PATH:-$(get_worktree_base_path "$num_worktrees")}

        # è¨­å®šå†…å®¹ã®ç¢ºèª
        [ "$QUIET" != true ] && echo
        [ "$QUIET" != true ] && echo "=== è¨­å®šå†…å®¹ã®ç¢ºèª ==="
        [ "$QUIET" != true ] && echo "ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒ: $base_branch"
        [ "$QUIET" != true ] && echo "ä½œæˆã™ã‚‹worktreeã®æ•°: $num_worktrees"
        [ "$QUIET" != true ] && echo "worktreeã®ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹: $worktree_base_path"
        [ "$QUIET" != true ] && echo
        [ "$QUIET" != true ] && echo "ä»¥ä¸‹ã®worktreeã¨ãƒ–ãƒ©ãƒ³ãƒãŒä½œæˆã•ã‚Œã¾ã™:"
        for i in $(seq 1 "$num_worktrees"); do
            local worktree_dir="${worktree_base_path}-${i}"
            local new_branch
            new_branch=$(basename "$worktree_dir")
            [ "$QUIET" != true ] && echo "  - worktree: $worktree_dir, ãƒ–ãƒ©ãƒ³ãƒ: $new_branch"
        done
        [ "$QUIET" != true ] && echo

        # å®Ÿè¡Œç¢ºèª
        if [ "$QUIET" != true ]; then
            read -p "ã“ã‚Œã‚‰ã®worktreeã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ (Y/n): " confirm
            if [[ $confirm =~ ^[Nn]$ ]]; then
                echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚"
                exit 0
            fi
        fi
        
        create_worktree "$base_branch" "$num_worktrees" "$worktree_base_path"
    fi

    [ "$QUIET" != true ] && echo
    [ "$QUIET" != true ] && success_msg "ã™ã¹ã¦ã®worktreeãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼"
    [ "$QUIET" != true ] && echo
    [ "$QUIET" != true ] && echo "ç¾åœ¨ã®worktreeä¸€è¦§:"
    [ "$QUIET" != true ] && git worktree list
    [ "$QUIET" != true ] && echo
    [ "$QUIET" != true ] && info_msg "ğŸš€ é–‹ç™ºã‚’é–‹å§‹ã§ãã¾ã™ï¼"
}

main "$@"